<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Пиратский клиент</title>
    <style type="text/tailwindcss">
        @theme {
        }
    </style>
</head>

<body class="flex h-screen flex-col bg-stone-900 text-white">

<!-- Навигационная панель -->
<nav class="flex justify-around border-b border-stone-700 bg-stone-800 p-4">
    <button onclick="" class="hover:text-lime-400">Главное лобби</button>
    <button onclick="" class="hover:text-lime-400">Настройки</button>
    <button onclick="" class="hover:text-lime-400">Редактор колоды</button>
    <button onclick="" class="hover:text-lime-400">Игра</button>
</nav>

<!-- Контейнер основного контента -->
<div id="app" class="flex h-0 flex-1">
    <!-- Левый чат -->
    <div id="chat" class="flex h-full w-1/4 flex-col bg-stone-800 p-4">
        <h2 class="mb-2 text-xl font-bold">Общий чат</h2>
        <!-- Контейнер истории сообщений -->
        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-2">
            <!-- Сообщения будут добавляться сюда -->
        </div>

        <!-- Форма ввода -->
        <form id="chat-form" class="mt-4 flex-shrink-0 border-t border-stone-700 pt-2">
            <input id="chat-input" type="text" placeholder="Сообщение..."
                   class="w-full rounded bg-stone-700 p-2 text-white focus:outline-none"/>
            <button type="submit"
                    class="mt-2 w-full rounded bg-lime-600 px-4 py-2 hover:bg-lime-500">
                Отправить
            </button>
        </form>
    </div>

    <!-- Правый динамический контент -->
    <div id="content" class="w-3/4 overflow-y-auto bg-stone-900 p-4">
    </div>
</div>

<script>
    class IdGen {
        constructor() { this.id = 0; }
        next(f) {
            if (!f) return ++this.id;
            f(++this.id);
            return this.id;
        }
    }
    const idGen = new IdGen(); // использовать для html id


    function dgebi   (id)           { return document.getElementById(id); }
    function dgebiael(id, event, f) { return document.getElementById(id).addEventListener(event, f); }


    // === Глобальное состояние клиента ===
    const client = {
        socket: null,
        user: {
            id: null,
            nick: 'Player' + Math.floor(Math.random() * 1000),
            rooms: []
        },
        callbacks: {}, // { req_id: callback }
        onMessage: {}, // { type: [callbacks] }
        volume: 0.5,
    };


    class Event {
        constructor  () { this.handlers = []; }
        add   (handler) { this.handlers.push(handler); }
        remove(handler) { const i = this.handlers.indexOf(handler); if (i !== -1) this.handlers.splice(i, 1); }
        clear        () { this.handlers = []; }
        emit  (...data) { [...this.handlers].forEach(h => h(...data)); }
    }


    class LobbyUi {
        constructor(container, rooms) {
            this.container = container;

            // События
            this.onHostGame = new Event();
            this.onJoinGame = new Event();
            this.onSpectateGame = new Event();

            // Статические данные
            this.updateRooms(rooms);
        }


        render() {
            const fns = [];

            // === Верхняя панель: создание хоста ===
            const hostSection = `
                <div class="mb-4 p-2 bg-stone-800 rounded flex justify-between items-center">
                    <input
                        id="${idGen.next(i => fns.push(() => this.passwordField = dgebi(i)))}"
                        type="text" placeholder="Пароль (не обязателен)" class="p-2 bg-stone-700 text-white w-1/2" />
                    <button
                        id="${idGen.next(i => fns.push(() => dgebiael(i, 'click', () => this.onHostGame.emit())))}"
                        class="px-4 py-2 bg-lime-600 hover:bg-lime-500 rounded">Создать хост</button>
                </div>
            `;

            // === Список комнат ===
            const roomElements = this.rooms.map(room => {
                return `
                    <div class="mb-2 p-3 bg-stone-800 rounded flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="font-bold">${room.name}</span>
                            <span class="text-sm text-stone-400">Игроков: ${room.players}</span>
                        </div>
                        <div class="space-x-2">
                            <button
                                id="${idGen.next(i => fns.push(() => dgebiael(i, 'click', () => this.onJoinGame.emit(room.id))))}"
                                class="px-3 py-1 bg-lime-600 hover:bg-lime-500 rounded">Играть</button>
                            <button
                                id="${idGen.next(i => fns.push(() => dgebiael(i, 'click', () => this.onSpectateGame.emit(room.id))))}"
                                class="px-3 py-1 bg-stone-600 hover:bg-stone-500 rounded">Смотреть</button>
                        </div>
                    </div>
                `;
            }).join('');

            const noRoomsMessage = this.rooms.length ? '' : `<div class="text-stone-400">Нет активных игр</div>`;

            // === Полная разметка ===
            this.container.innerHTML = `
                <h1 class="text-2xl font-bold mb-4">Список комнат</h1>
                ${hostSection}
                ${roomElements}
                ${noRoomsMessage}
            `;

            fns.forEach(f => f());
        }


        updateRooms(roomList) {
            this.rooms = [...roomList];
            this.render();
        }
    }


    // тест
    const rooms = [
        { id: "id-0", name: "test", players: 1},
        { id: "id-1", name: "echo", players: 2},
        { id: "id-2", name: "crab", players: 2, password: "test" },
    ];
    const lobbyUi = new LobbyUi(document.getElementById('content'), rooms);
    lobbyUi.onHostGame.add(i => console.log(`host: ${i}`));
    lobbyUi.onJoinGame.add(i => console.log(`join: ${i}`));
    lobbyUi.onSpectateGame.add(i => console.log(`spec: ${i}`));


    // === Инициализация соединения ===
    function connectToServer(url = 'ws://localhost:10800') {
        client.socket = new WebSocket(url);

        client.socket.addEventListener('open', () => {
            console.log("Соединение установлено");

            // Отправляем начальный запрос (автоматический login)
            // send({type: 'init', req_id: generateReqId(), nick: client.user.nick});
        });

        client.socket.addEventListener('message', event => {
            try {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            } catch (e) {
                console.error(event.data);
                console.error("Ошибка парсинга:", e);
            }
        });

        client.socket.addEventListener('close', event => {
            console.log("Соединение закрыто", event.code, event.reason);
            // Можно переподключиться автоматически
        });

        client.socket.addEventListener('error', error => {
            console.error("Ошибка WebSocket:", error.message);
        });
    }

    // === Функция отправки сообщений ===
    function send(message, onResponse = null) {
        if (!client.socket || client.socket.readyState !== WebSocket.OPEN) {
            console.warn("Соединение не установлено");
            return;
        }

        const req = typeof message === 'object' ? message : {};
        req.req_id = req.req_id || generateReqId();

        if (onResponse && req.req_id) {
            client.callbacks[req.req_id] = onResponse;
        }

        client.socket.send(JSON.stringify(req));
        return req.req_id;
    }

    function generateReqId() {
        return Math.random().toString(36).substr(2, 9);
    }

    // === Обработка входящих сообщений ===
    function handleServerMessage(msg) {
        if (!msg.type) return;

        // === Если есть req_id → вызываем callback ===
        if (msg.req_id && client.callbacks[msg.req_id]) {
            client.callbacks[msg.req_id](msg);
            delete client.callbacks[msg.req_id];
        }

        // === Общая обработка по типу сообщения ===
        const handlers = client.onMessage[msg.type] || client.onMessage['*'] || [];

        handlers.forEach(handler => handler(msg));
    }

    // === Регистрация обработчиков событий ===
    function on(type, handler) {
        if (!client.onMessage[type]) {
            client.onMessage[type] = [];
        }
        client.onMessage[type].push(handler);
    }


    // точка входа в основную программу


    // === Примеры использования ===
    connectToServer();

    // === При получении данных пользователя ===
    on('user_info', msg => {
        client.user.id = msg.user_id;
        // document.getElementById('username').value = msg.nick;
        console.log("Твой ID:", msg.user_id);
    });

    // === При изменении ника ===
    on('ack', msg => {
        if (msg.type === 'change_nick') {
            console.log("Никнейм успешно изменён");
        }
    });

    on('error', msg => {
        alert("Ошибка: " + msg.error);
    });

    // === При создании новой комнаты ===
    on('room_created', msg => {
        addRoomToList(msg.room_id, msg.room_type);
    });

    // === При рассылке списка комнат ===
    on('room_list', msg => {
        updateRoomList(msg.list);
    });

    // === При получении нового сообщения ===
    on('message', msg => {
        addMessageToChat(msg.room_id, `[${msg.nick}] ${msg.content}`);
    });

    // === Общая логика UI ниже ===

    // === Отправка сообщений из общего чата ===
    document.getElementById('chat-form').addEventListener('submit', e => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message || !socket) return;

        socket.send(JSON.stringify({
            type: 'chat',
            text: `[${state.username}] ${message}`
        }));

        input.value = '';
    });

    // === Отправка сообщений из игрового чата ===
    document.body.addEventListener('submit', e => {
        if (e.target.id !== 'game-chat-form') return;
        e.preventDefault();

        const input = document.getElementById('game-chat-input');
        const message = input.value.trim();
        if (!message || !socket) return;

        socket.send(JSON.stringify({
            type: 'game_move',
            text: `[${state.username}] ${message}`,
            room: state.currentRoom
        }));

        input.value = '';
    });
</script>
</body>
</html>