<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>–ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–ª–∏–µ–Ω—Ç</title>
    <style type="text/tailwindcss">
        @theme {}
    </style>
</head>

<body class="flex h-screen flex-col bg-stone-900 text-white">

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
<nav class="flex justify-around border-b border-stone-700 bg-stone-800 p-4">
    <button onclick="navigate('lobby')" class="hover:text-lime-400">–ì–ª–∞–≤–Ω–æ–µ –ª–æ–±–±–∏</button>
    <button onclick="navigate('settings')" class="hover:text-lime-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button onclick="navigate('deck')" class="hover:text-lime-400">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–ª–æ–¥—ã</button>
    <button onclick="navigate('game')" class="hover:text-lime-400">–ò–≥—Ä–∞</button>
</nav>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
<div id="app" class="h-0 flex flex-1">
    <!-- –õ–µ–≤—ã–π —á–∞—Ç -->
    <div id="chat" class="flex h-full w-1/3 flex-col bg-stone-800 p-4">
        <h2 class="mb-2 text-xl font-bold">–û–±—â–∏–π —á–∞—Ç</h2>
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-2">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
        <form id="chat-form" class="mt-4 flex-shrink-0 border-t border-stone-700 pt-2">
            <input id="chat-input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
                   class="w-full rounded bg-stone-700 p-2 text-white focus:outline-none" />
            <button type="submit"
                    class="mt-2 w-full rounded bg-lime-600 px-4 py-2 hover:bg-lime-500">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>
    </div>

    <!-- –ü—Ä–∞–≤—ã–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="content" class="w-2/3 overflow-y-auto bg-stone-900 p-4"></div>
</div>

<script>
    // === –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
    const state = {
        page: 'lobby',
        username: localStorage.getItem('username') || 'Player' + Math.floor(Math.random() * 1000),
        volume: parseFloat(localStorage.getItem('volume')) || 0.5,
        currentRoom: null
    };

    // === –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage ===
    function saveSettings() {
        localStorage.setItem('username', state.username);
        localStorage.setItem('volume', state.volume);
    }

    // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ ===
    function navigate(page) {
        state.page = page;
        renderContent();
    }

    // === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ ===
    function renderContent() {
        const contentDiv = document.getElementById('content');
        switch (state.page) {
            case 'lobby':
                contentDiv.innerHTML = renderLobby();
                break;
            case 'settings':
                contentDiv.innerHTML = renderSettings();
                break;
            case 'deck':
                contentDiv.innerHTML = '<div class="mt-10 text-center">üõ†Ô∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–ª–æ–¥—ã (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</div>';
                break;
            case 'game':
                contentDiv.innerHTML = renderGame();
                break;
            default:
                contentDiv.innerHTML = '';
        }
    }

    // === –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ì–ª–∞–≤–Ω–æ–µ –ª–æ–±–±–∏ ===
    function renderLobby() {
        return `
            <h1 class="mb-4 text-2xl font-bold">–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</h1>
            <div class="space-y-2">
                <div class="cursor-pointer rounded bg-stone-700 p-2 hover:bg-stone-600" onclick="joinRoom('room_001')">–ö–æ–º–Ω–∞—Ç–∞ room_001</div>
                <div class="cursor-pointer rounded bg-stone-700 p-2 hover:bg-stone-600" onclick="joinRoom('room_002')">–ö–æ–º–Ω–∞—Ç–∞ room_002</div>
                <button onclick="createRoom()" class="mt-4 w-full rounded bg-lime-600 p-2 hover:bg-lime-500">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
        `;
    }

    // === –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    function renderSettings() {
        return `
            <h1 class="mb-4 text-2xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <div class="mb-4">
                <label class="mb-2 block">–ò–º—è –∏–≥—Ä–æ–∫–∞:</label>
                <input id="username" value="${state.username}" class="w-full rounded bg-stone-700 p-2 text-white" />
            </div>
            <div class="mb-4">
                <label class="mb-2 block">–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞ (${state.volume})</label>
                <input id="volume" type="range" min="0" max="1" step="0.1" value="${state.volume}" class="w-full" />
            </div>
            <button onclick="saveUserSettings()" class="rounded bg-lime-600 px-4 py-2 hover:bg-lime-500">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        `;
    }

    // === –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ò–≥—Ä–∞ ===
    function renderGame() {
        return `
            <h1 class="mb-4 text-2xl font-bold">–ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</h1>
            <div id="game-chat" class="mb-4 h-64 overflow-y-auto rounded bg-stone-700 p-2 space-y-2" style="height: 300px;"></div>
            <form id="game-chat-form" class="flex">
                <input id="game-chat-input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 rounded bg-stone-700 p-2 text-white focus:outline-none" />
                <button type="submit" class="ml-2 rounded bg-lime-600 px-4 py-2 hover:bg-lime-500">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        `;
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    function saveUserSettings() {
        const usernameInput = document.getElementById('username').value.trim();
        const volumeInput = document.getElementById('volume').value;

        if (usernameInput) {
            state.username = usernameInput;
        }
        state.volume = volumeInput;

        saveSettings();
        alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    }

    // === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ ===
    function joinRoom(roomId) {
        state.currentRoom = roomId;
        navigate('game');

        setupGameChat(roomId);

        const gameChat = document.getElementById('game-chat');
        gameChat.innerHTML = `<div class="text-green-400">–í—ã –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É ${roomId}</div>`;
    }

    // === –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã ===
    function createRoom() {
        const newRoom = 'room_' + Math.random().toString(36).substr(2, 5);
        state.currentRoom = newRoom;
        navigate('game');

        setupGameChat(newRoom);

        const gameChat = document.getElementById('game-chat');
        gameChat.innerHTML = `<div class="text-green-400">–í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É: ${newRoom}</div>`;
    }

    // === –ß–∞—Ç —á–µ—Ä–µ–∑ WebSocket ===
    let socket;

    function setupGameChat(room) {
        if (socket) {
            socket.close();
        }

        socket = new WebSocket('ws://localhost:10800');

        socket.addEventListener('open', () => {
            console.log(`–ü–æ–¥–∫–ª—é—á—ë–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ ${room}`);
            socket.send(JSON.stringify({ type: 'join', room }));
        });

        socket.addEventListener('message', event => {
            try {
                const message = JSON.parse(event.data);
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML += `<div class="p-1">${message.text}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;

                // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –∏–≥—Ä—ã ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∞–º —Ç–æ–∂–µ
                if (state.page === 'game') {
                    const gameChatBox = document.getElementById('game-chat');
                    gameChatBox.innerHTML += `<div class="p-1">${message.text}</div>`;
                    gameChatBox.scrollTop = gameChatBox.scrollHeight;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
            }
        });

        socket.addEventListener('close', () => {
            console.log('WebSocket –∑–∞–∫—Ä—ã—Ç');
        });
    }

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ–±—â–µ–≥–æ —á–∞—Ç–∞ ===
    document.getElementById('chat-form').addEventListener('submit', e => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message || !socket) return;

        socket.send(JSON.stringify({
            type: 'chat',
            text: `[${state.username}] ${message}`
        }));

        input.value = '';
    });

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏–≥—Ä–æ–≤–æ–≥–æ —á–∞—Ç–∞ ===
    document.body.addEventListener('submit', e => {
        if (e.target.id !== 'game-chat-form') return;
        e.preventDefault();

        const input = document.getElementById('game-chat-input');
        const message = input.value.trim();
        if (!message || !socket) return;

        socket.send(JSON.stringify({
            type: 'game_move',
            text: `[${state.username}] ${message}`,
            room: state.currentRoom
        }));

        input.value = '';
    });

    // === –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä ===
    function initApp() {
        renderContent();
        setupGameChat('main_lobby');
    }

    window.onload = () => {
        initApp();
    };
</script>

</body>
</html>